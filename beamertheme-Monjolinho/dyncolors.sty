%! Package = dyncolors
%! Author = Jander Moreira
%! Date = 07/10/2022

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{dyncolors}[2022/10/07 Dynamic colors for beamer]

\@ifclassloaded{beamer}{}{
    \PackageError{dyncolors}{'dyncolors' is a package for Beamer}{The package 'dyncolors' can only be loaded from class beamer}
}

% Options

\RequirePackage{xcolor}

% Color theme
\definecolor{dDarkBlue}{HTML}{14163B}
\definecolor{dBrown}{HTML}{804722}
\definecolor{dBlue}{HTML}{0264C7}
\definecolor{dLightYellow}{HTML}{F5EDD0}
\definecolor{dGreen}{HTML}{065C61}

% Darker colors
\definecolor{dDarkJungleGreen}{HTML}{051D1A}
\definecolor{dHunterGreen}{HTML}{345B3F}
\definecolor{dCaputMortuum}{HTML}{5E2325}
\definecolor{dGamboge}{HTML}{D89818}
\definecolor{dRussianViolet}{HTML}{470E4A}


% List environment
\ExplSyntaxOn
\cs_generate_variant:Nn \int_set:Nn { cn }
\cs_generate_variant:Nn \seq_set_split:Nnn { cnn }

\NewDocumentCommand { \ResetColor } { m } {
    \int_set:cn { g_#1_current_int } { 0 }
}
\NewDocumentCommand { \NewColorList } { m } {
    \seq_new:c { g_#1_colors_seq }
    \int_new:c { g_#1_current_int }
    \ResetColor { #1 }
}
\NewDocumentCommand { \SetColorList } { mm }{
    \seq_set_split:cnn { g_#1_colors_seq } { , } { #2 }
}
\NewDocumentCommand { \GetColor } { m } {
    \int_if_exist:NTF \l_index_int {} { \int_new:N \l_index_int }
    \int_set:Nn \l_index_int { \int_use:c { g_#1_current_int } }
    \tl_gset:Nn \CurrentColor {
        \seq_item:cn { g_#1_colors_seq  }{ \int_eval:n {\int_use:N  \l_index_int + 1} }
    }
    \int_set:cn { g_#1_current_int } {
        \int_mod:nn { \l_index_int + 1 } { \seq_count:c { g_#1_colors_seq } }
    }
    % \tl_use:N \CurrentColor
}
\ExplSyntaxOff

\NewColorList{main}
\SetColorList{main}{dDarkJungleGreen, dCaputMortuum, dRussianViolet}

\NewColorList{second level}
\SetColorList{second level}{dHunterGreen, dGamboge}

\newcommand{\NextColor}{%
    \mode<presentation>
    \pgfmathparse{int(mod(\theitemlevel, 2))}
    \ifnum\pgfmathresult = 0
        \GetColor{main}
    \else
        \GetColor{second level}
    \fi
    \color{\CurrentColor}%
    % \setbeamercolor{itemize/enumerate body}{fg = \CurrentColor}
    % \usebeamercolor[fg]{itemize/enumerate body}
    \mode<all>
}

\newcounter{itemlevel}
\defcounter{itemlevel}{-1}
\AtBeginEnvironment{itemize}{%
    \ResetColor{main}
    \defcounter{itemlevel}{\theitemlevel + 1}
}
\AtEndEnvironment{itemize}{%
    \defcounter{itemlevel}{\theitemlevel - 1}
}
\AtBeginEnvironment{enumerate}{%
    \ResetColor{main}
    \defcounter{itemlevel}{\theitemlevel + 1}
}
\AtEndEnvironment{enumerate}{%
    \defcounter{itemlevel}{\theitemlevel - 1}
}

\NewCommandCopy\BeamerCallItem\beamer@callorigitem
\NewCommandCopy\BeamerParseItem\beamer@parseitem

% %! parser = off
% \RenewDocumentCommand{\beamer@callorigitem}{}{%
%     \NextColor% --- Patched here
%     \@ifnextchar[\beamer@@callorigitem{%
%         \beamer@origitem\kern0pt\ignorespaces%
%     }%
% }
% \RenewDocumentCommand{\beamer@parseitem}{d<>}{%
%     \gdef\beamer@closeitem{%
%         \if@inlabel\indent\par\fi
%         \end{actionenv}%
%         \@noparitemfalse%
%     }%
%     \NextColor% --- Patched here
%     \begin{actionenv}<#1>%
%     \NextColor% --- Patched here
%     \beamer@callorigitem%
% }
% %! parser = on

%! parser = off
\newcommand{\ColorItemsOn}{%
    \RenewDocumentCommand{\beamer@callorigitem}{}{%
        \NextColor% --- Patched here
        \@ifnextchar[\beamer@@callorigitem{%
            \beamer@origitem\kern0pt\ignorespaces%
        }%
    }%
    \RenewDocumentCommand{\beamer@parseitem}{d<>}{%
        \gdef\beamer@closeitem{%
            \if@inlabel\indent\par\fi
            \end{actionenv}%
            \@noparitemfalse%
        }%
        \NextColor% --- Patched here
        \begin{actionenv}<##1>%
        \NextColor% --- Patched here
        \beamer@callorigitem%
    }%
}
\newcommand{\ColorItemsOff}{%
    \RenewDocumentCommand{\beamer@callorigitem}{}{\BeamerCallItem}%
    \RenewDocumentCommand{\beamer@parseitem}{d<>}{\BeamerParseItem<##1>}%
}
%! parser = on

\ColorItemsOn %% defaults to On


